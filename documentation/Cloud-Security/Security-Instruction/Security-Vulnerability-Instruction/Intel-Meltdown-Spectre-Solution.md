
# Suggested Fix Solution for Intel Processor Meltdown and Spectre Security Vulnerability

On January 3, 2018, Intel processor chips were found to have severe security vulnerability. The vulnerability was caused by design flaws at the hardware level of the chip, which could lead to unauthorized access to kernel sensitive data in Windows/Linux systems; for example, ordinary users of the operating system may obtain the administrator data. To prevent your virtual machine from being affected by this vulnerability, please decide whether you need to upgrade and fix the vulnerability according to your own business situation. If you need to upgrade, please refer to the following instructions and suggestions to complete the vulnerability patch of the inventory virtual machine.

(From January 9 to January 12, JD Cloud will fix the vulnerabilities in the basic architecture infrastructure of all the machine rooms in all regions as planned, which may lead to partial verification failure after patch or kernel update during this period. In such event, please try verification again after 05:00 on January 12.)

You can refer to the Microsoft and Redhat official fix solutions for system upgrade:

* Microsoft：[https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)

* Redhat：[https://access.redhat.com/security/vulnerabilities/speculativeexecution](https://access.redhat.com/security/vulnerabilities/speculativeexecution)

JD Cloud technology team verified and organized the official fix solutions and gave the following recommended fix solutions for reference only:

## CentOS 6.X System

### System Version
CentOS 6.1、6.3、6.4、6.5、6.6、6.7、6.8  

### Official Security Announcement

* [https://access.redhat.com/security/vulnerabilities/speculativeexecution](https://access.redhat.com/security/vulnerabilities/speculativeexecution)
* [https://access.redhat.com/errata/RHSA-2018:0007](https://access.redhat.com/errata/RHSA-2018:0007)
* [https://access.redhat.com/errata/RHSA-2018:0008](https://access.redhat.com/errata/RHSA-2018:0008)  

### Official Patch Status
RedHat has officially provided security patches, which are included in the latest kernel of CentOS 6 official yum source. 

### Patch Update Method
1. Well back up the virtual machine data
2. Switch to the root user
3. Enter command in the command line: yum update kernel
Note: After the update, kernels of CentOS 6.1~6.8 versions will all eventually be upgraded to the latest kernel version of CentOS 6.9 (kernel-2.6.32-696.18.7.el6)
4. Reboot the system          
### Verification Method
Method 1:
Enter the command grep -e 'CONFIG_KAISER' /boot/config-`uname -r` as the root user    

If it shows CONFIG_KAISER=y, it proves that the patch has taken effect  

Method 2:
Enter the command uname -r as the root user; if it shows 2.6.32-696.18.7.el6, it proves that the patch has taken effect  

## CentOS 7.X System
### System Version
CentOS 7.1、7.2、7.3、7.2 NAT Gateway
### Official Security Announcement

* [https://access.redhat.com/security/vulnerabilities/speculativeexecution](https://access.redhat.com/security/vulnerabilities/speculativeexecution)
* [https://access.redhat.com/errata/RHSA-2018:0007](https://access.redhat.com/errata/RHSA-2018:0007)
* [https://access.redhat.com/errata/RHSA-2018:0008](https://access.redhat.com/errata/RHSA-2018:0008)    

### Official Patch Status
RedHat has officially provided security patches, which are included in the latest kernel of CentOS 7 official yum source.

### Patch Update Method

1. Well back up the virtual machine data
2. Switch to the root user
3. Enter command in the command line: yum update kernel
Note: After the update, kernels of CentOS 7.1~7.3 versions will all eventually be upgraded to the latest kernel version of CentOS 7.4 (kernel-3.10.0-693.11.6.el7)
4. Reboot the system   

### Verification Method

Method 1:

1. ibpb_enabled appears under the directory of /sys/kernel/debug/x86/

pti_enabled ibrs_enabled。                 

2. Enter the command cat /sys/kernel/debug/x86/ pti_enabled as the root user; if it shows 1, it proves that the patch has taken effect   

Method 2:


Enter the command uname -r as the root user; if it shows 3.10.0-693.11.6.el7, it proves that the patch has taken effect

## Ubuntu System

### System Version

Ubuntu 12.04、14.04、16.04                

### Official Security Announcement

https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown

### Official Patch Status

Ubuntu has officially provided security patches.             

### Patch Update Method

1. Well back up the virtual machine data
2. Switch to the root user  
3. Ubuntu 12.04 run command:

    ```
    apt-get update     apt-get install linux-image-3.13.0-139-generic
    ```

   Ubuntu 14.04/16.04 run command:

    ```
    apt-get update     apt-get install linux-image-4.4.0-109-generic
    ```

4. Reboot the system

### Verification Method

Enter the command uname -r as the root user 

If the Ubuntu 12.04 system shows 3.13.0-139-generic, it proves that the patch has taken effect

If the Ubuntu 14.04/16.04 system shows 4.4.0-109-generic, it proves that the patch has taken effect

## Windows Server System Standard Edition

### System Version

Windows Server 2012 R2 Standard Edition 64-bit Chinese Version                

### Official Security Announcement

https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution

### Official Patch Status

Microsoft has officially provided security patches.

https://www.catalog.update.microsoft.com/Search.aspx?q=KB4056898 

### Patch Update Method

1. Well back up the virtual machine data
2. Download the windows patches for 2012 R2.
    https://www.catalog.update.microsoft.com/Search.aspx?q=KB4056898
3. After downloading, please follow the installation guide to complete the installation (administrator mode), and reboot the machine according to the notification after it is successfully completed.
4. In administrator mode, open powershell command line to add a registry key. The content is as follows:
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride /t REG_DWORD /d 0 /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverrideMask /t REG_DWORD /d 3 /f
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
5. Reboot the virtual machine                

### Verification Method

1. Verify whether the patch has taken effect using the verification tool:

    Download link for official verification tool: https://gallery.technet.microsoft.com/scriptcenter/Speculation-Control-e36f0050
2. Please complete the verification as per the following steps after decompressing the verification tool:
 ```
 PS> # Save the current execution policy so it can be reset
 PS> $SaveExecutionPolicy = Get-ExecutionPolicy
 PS> Set-ExecutionPolicy RemoteSigned -Scope Currentuser
 PS> CD C:\ADV180002\SpeculationControl
 PS> Import-Module .\SpeculationControl.psd1
 PS> Get-SpeculationControlSettings
 PS> # Reset the execution policy to the original state
 PS> Set-ExecutionPolicy $SaveExecutionPolicy -Scope Currentuser
```
3. If the verification result shows the following information, it means that the verification is successful:
 ```
 PS C:\> Get-SpeculationControlSettings
 Speculation control settings for CVE-2017-5715 [branch target injection]
 Hardware support for branch target injection mitigation is present: True
 Windows OS support for branch target injection mitigation is present: True
 Windows OS support for branch target injection mitigation is enabled: True
 Speculation control settings for CVE-2017-5754 [rogue data cache load]
 Hardware requires kernel VA shadowing: True
 Windows OS support for kernel VA shadow is present: True
 Windows OS support for kernel VA shadow is enabled: True
 Windows OS support for PCID optimization is enabled: True
```
(Please refer to the Microsoft official instructions for the above patch installation and verification process, see: [https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution))

## Windows Server System DC Edition
### System Version

Windows Server 2008 R2 DC Edition 64-bit Chinese Version                

### Official Security Announcement

[https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)

### Official Patch Status

Microsoft has officially provided security patches.

[https://www.catalog.update.microsoft.com/Search.aspx?q=KB4056897](https://www.catalog.update.microsoft.com/Search.aspx?q=KB4056897)

### Patch Update Method

1. Well back up the virtual machine data
2. Download the windows patches for 2008 R2:
 [https://www.catalog.update.microsoft.com/Search.aspx?q=KB4056897](https://www.catalog.update.microsoft.com/Search.aspx?q=KB4056897)
3. After downloading, please follow the installation guide to complete the installation (administrator mode), and reboot the machine according to the notification after it is successfully completed.
4. In administrator mode, open powershell command line to add a registry key. The content is as follows:
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride /t REG_DWORD /d 0 /f
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverrideMask /t REG_DWORD /d 3 /f
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
5. Reboot the virtual machine                

### Verification Method

1. Download through the below link and use the verification tool to verify whether the patch has taken effect (For there is error in the official tool provided, please use the tool modified by JD Cloud to verify): [http://storage.jd.com/userdownload/SpeculationControl-2008.zip](http://storage.jd.com/userdownload/SpeculationControl-2008.zip)

2. Please complete the verification as per the following steps after decompressing the verification tool:
 ```
 PS> # Save the current execution policy so it can be reset
 PS> $SaveExecutionPolicy = Get-ExecutionPolicy
 PS> Set-ExecutionPolicy RemoteSigned -Scope Currentuser
 PS> CD C:\ADV180002\SpeculationControl
 PS> Import-Module .\SpeculationControl.psd1
 PS> Get-SpeculationControlSettings
 PS> # Reset the execution policy to the original state
 PS> Set-ExecutionPolicy $SaveExecutionPolicy -Scope Currentuser
 ```
3. If the verification result shows the following information, it means that the verification is successful:
 ```
 PS C:\> Get-SpeculationControlSettings
 Speculation control settings for CVE-2017-5715 [branch target injection]
 Hardware support for branch target injection mitigation is present: True
 Windows OS support for branch target injection mitigation is present: True
 Windows OS support for branch target injection mitigation is enabled: True
 Speculation control settings for CVE-2017-5754 [rogue data cache load]
 Hardware requires kernel VA shadowing: True
 Windows OS support for kernel VA shadow is present: True
 Windows OS support for kernel VA shadow is enabled: True
 Windows OS support for PCID optimization is enabled: True
 ```
(Please refer to the Microsoft official instructions for the above patch installation and verification process, see: [https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution](https://support.microsoft.com/en-us/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution))        
