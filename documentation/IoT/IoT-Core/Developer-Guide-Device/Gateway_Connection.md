# Gateway Function


- The gateway is responsible for verification of agent sub-device, data communication with cloud and management on information and status of sub-device. Communication between the gateway and the sub-device shall be processed by a manufacturer.
- Gateway functions can be controlled via the DEVICE_GATEWAY Macro in iot_config.h.
- GATEWAY_MQTT_COMM_ENABLED enables mqtt network channel of gateway. The gateway supports one model and one password and one machine one password of sub-device.
- The executable file generated by compilation is in build/x86_64/bin/gateway_example.


## Device Topology

- Directly connected device: can be directly connected to the cloud
- Gateway device: Have the capacity of managing sub-devices and connecting the cloud as the sub-device agent
- Sub-device: Device connected to the cloud via a gateway agent

![image](../../../../image/IoT/IoT-DeviceSDK/Gateway-Topology.png)

## Sending and receiving of sub-device

- On-line and off-line status of a sub-device is informed to the cloud via a gateway
- The sub-device has heart beats, but the gateway does not have the same
- The gateway needs to subscribe the sub-device topic and synchronize response
- The gateway can send and receive sub-device data in batches

## Sub-device Activation

Topology shall be configured for the sub-device at the background; the sub-device can get DS/ID for several times; and only the dependence of the sub-device to the gateway is released, the sub-device can be related to another gateway. When independence is relieved, the original gateway will lose the control to sub-device.

![image](../../../../image/IoT/IoT-DeviceSDK/Device_Activation.PNG)

Gateway Function Architecture Drawing:
![image](../../../../image/IoT/IoT-DeviceSDK/DeviceGateway.PNG)

## Create a new device

- `Int iot_gateway_construct(iot_dev_type_t dev_type, iot_dev_auth_info_t *meta_info);`
- API description: Create a new device, including types of gateway and sub-device.
- Return value: Device ID will be returned if succeeded and FAIL_RETURN will be returned if failed
- Parameter Description:

|  Parameter Name   |      Parameter Type       | Required |        Description        |
| :-------: | :-----------------: | :--: | :----------------: |
| dev_type  |   iot_dev_type_t    |  Yes  | Device Type to Be Created |
| meta_info | iot_dev_auth_info_t |  Yes  |   Device Verification Information   |

```
Device type dev_type description:
		IOT_DEV_TYPE_GATEWAY 	gateway device  
		IOT_DEV_TYPE_SUBDEV 	sub-device
```



## Enable device connection network and subject subscription

- `int iot_gateway_connect(int devid);`
- API description: Enable network connection for appointed device.
- Return value: SUCCESS_RETURN will be returned if succeeded and FAIL_RETURN will be returned if failed
- Parameter Description:

| Parameter Name | Parameter Type | Required |         Description         |
| :----: | :------: | :--: | :------------------: |
| devid  |   int    |  Yes  | ID of Device Requiring Network Connection |

## Receive network information and distribution event

- `void iot_gateway_yield(int timeout_ms);`
- API description: Receive cloud distribution event and distribute event to registered callback method.
- Return value: void
- Parameter Description:

|   Parameter Name   | Parameter Type | Required |         Description         |
| :--------: | :------: | :--: | :------------------: |
| timeout_ms |   int    |  Yes  | Network Data Time-out Period |



## Disable network connection and recycle device resource

- `int iot_gateway_destroy(int devid);`
- API description: Disable network connection of appointed device and recycle device resource.
- Return value: SUCCESS_RETURN will be returned if succeeded and FAIL_RETURN will be returned if failed
- Parameter Description:

| Parameter Name | Parameter Type | Required |    Description    |
| :----: | :------: | :--: | :--------: |
| devid  |   int    |  Yes  | id of Appointed Device |

## Send data to Cloud

- `int iot_gateway_report(int devid, iot_msg_type_t msg_type, unsigned char *payload, int payload_len);`
- API description: Send data to Cloud.
- Return value: information id will be returned if succeeded and FAIL_RETURN will be returned if failed
- Parameter Description:

|   Parameter Name    |    Parameter Type    | Required |    Description    |
| :---------: | :------------: | :--: | :--------: |
|    devid    |      int       |  Yes  | id of Appointed Device |
|  msg_type   | iot_msg_type_t |  Yes  |  Message Type  |
|   payload   | Unsigned char* |  Yes  |   Message Body   |
| Payload_len |      int       |  Yes  | Message Body Length |

```
Message type msg_type description:
    IOT_GATEWAY_POST_PROPERTY           Send read only attribute of gateway or sub-device
    IOT_GATEWAY_BATCH_POST              Send data and events of sub-device in batches
    IOT_GATEWAY_POST_EVENT              Send events of gateway or sub-device
    IOT_GATEWAY_SHADOW_REPLY            Send shadow response of gateway or sub-device
    IOT_GATEWAY_SERVICE_REPLY           Send service response of gateway or sub-device
    IOT_GATEWAY_DEVICE_UPDATE_SHADOW    Send shadow of gateway or sub-device
    IOT_GATEWAY_GET_SHADOW              Get shadow of gateway or sub-device
    IOT_GATEWAY_SUBDEV_LOGIN            Gateway sub-device logs in
    IOT_GATEWAY_SUBDEV_LOGOUT           Gateway sub-device logs out

```


## Get identifier and device secret of sub-device

bool iot_gateway_dynamic_auth(iot_dev_auth_info_t *meta_info,iot_cm_init_param_t *params);

API description: get identifier and device secret of device for the sub-device of one model and one password.

Return value: true will be returned if succeeded and false will be returned if failed

Parameter Description:

| **Parameter Name**   | **Parameter Type**     | **Required** | **Description**           |
| ---------- | ------------------- | -------- | ------------------ |
| meta_info  | iot_dev_auth_info_t | Yes       | Verification Information of This Side     |
| params     | iot_cm_init_param_t | Yes       | Initial Parameter for Network Connection |


## Send data to Cloud

- `uint32_t iot_gateway_generate_msgid();`
- API description: Generate message id.
- Return value: Message id will be returned if succeeded and -1 will be returned if failed 
