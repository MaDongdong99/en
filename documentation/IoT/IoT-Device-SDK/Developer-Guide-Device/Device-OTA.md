# Device End OTA Upgrade Guidance

The IoT platform informs a device of firmware upgrade through MQTT protocol and then the device downloads a firmware package through http/https. During the download and upgrade, the overall progress will be reported and the completeness of the firmware package will be checked. At present, the OTA function of device end SDK only supports gateway and directly connected devices.

## SDK File Description:

​	1. The OTA function is enabled through DEVICE_OTA in iot_config.h.

​	2. The executable file generated by compilation is in build/x86_64/bin/ota_example

## Note:

1. The device firmware version number shall be reported respectively during system start and after upgrade succeeds.

2. After the IoT Console initiates the batch upgrade, the device upgrade operation record status is to be upgraded, and the timer starts once the device reports the progress. 

3. Whether the device end OTA upgrade succeeds or not can be judged according to the version number.

4. The upgrade message pushed by the server cannot be received when the device is off-line.

## Firmware Upgrade Process:

![升级流程](../../../../image/IoT/IoT-Engine/OTA/SDK-OTA01.png)

## API Description

### 1. Initialize OTA

 `void *iot_ota_init(const char *product_key, const char *device_name, void * mqtt_client);`

API Description: The resources initializing OTA will subscribe the topic issued by the upgrade command by default.

Return Value: An ota instance will be returned if succeeded and null will be returned if failed

Parameter Description:

| **Parameter Name**  | **Parameter Type**  | **Compulsory** | **Description**                          |
| ----------- | ------------- | -------- | --------------------------------- |
| product_key | const  char * | Yes       | product_key of device                 |
| device_name | const  char * | Yes       | device_name of device                 |
| mqtt_client | void*         | Yes       | mqtt instance, which is generated by creating an api through mqtt instance |

Topic format issued by upgrade command: 

`/sys/{productKey}/{identifier}/ota/firmware/upgrade`

Distribution data format:

```
{
"msgId ":"123",//Message id
"version":"1.0",//Protocol Version
"data ":{
	"policy":" standard/ silent",//Upgrade Mode, not exist if a device takes initiative to obtain firmware information
	"size":432945,//Firmware Size
	"firmwareVersion":"Firmware Version",
	"url":"Firmware Address",
	"sign":"Firmware Signature",
	"signMethod":"Md5"//Signature Mode
	}
}
```

### 2. Cancel resources applied by OTA

 `int iot_ota_destroy(void *handle);`

API Description: Cancel resources applied by OTA.

Return Value: 0 will be returned if succeeded and iot_ota_err_t will be returned if failed

Parameter Description:

| **Parameter Name** | **Parameter Type** | **Compulsory** | **Description**          |
| ---------- | ------------ | -------- | ----------------- |
| handle     | Void*        | Yes       | ota instance generated by init |

### 3. Report upgrade progress and upgrade status

`int iot_ota_report_progress(void*handle iot_ota_status_t status,uint32_t progress);`

API Description: Report the download and upgrade progresses and report the succeeded or failed status.

Return Value: 0 will be returned if succeeded and iot_ota_err_t will be returned if failed

Parameter Description:

| **Parameter Name** | **Parameter Type**     | **Compulsory** | **Description**                 |
| ---------- | ---------------- | -------- | ------------------------ |
| handle     | Void*            | Yes       | ota instance                  |
| status     | iot_ota_status_t | Yes       | Report type iot_ota_status_t |
| progress   | uint32_t         | Yes       | Download and upgrade progress 0-100    |

### 4. Report firmware version

`int iot_ota_report_firmware_version(void *handle, const char *version);`

API Description: Report current firmware version information.

Return Value: 0 will be returned if succeeded and iot_ota_err_t will be returned if failed

Parameter Description:

| **Parameter Name** | **Parameter Type**  | **Compulsory** | **Description** |
| ---------- | ------------- | -------- | -------- |
| handle     | void*         | Yes       | ota instance  |
| version    | const  char * | Yes       | Version information |

### 5.  Judge if current status is downloading

`int iot_ota_is_fetching(void *handle);`

API Description: Judge if current status is downloading. The status is as follows:

​	uninit: Download a module not initialized

​	init: Initialized

​	fetching: Downloading

​	fetched: Download ended

Return Value: 1 will be returned if it is downloading and 0 will be returned if it is not downloading   

Parameter Description:

| **Parameter Name** | **Parameter Type** | **Compulsory** | **Description** |
| ---------- | ------------ | -------- | -------- |
| handle     | Void*        | Yes       | ota instance  |

### 6.    Judge if current status is download ended

`int iot_ota_fetch_finish(void *handle);`

API Description: Judge if current status is download ended and there are four statuses: uninit (download a module not initialized), init (initialized), fetching (downloading), and fetched (download ended).

Return Value: 1 will be returned if ended and 0 will be returned if on-going

Parameter Description:

| **Parameter Name** | **Parameter Type** | **Compulsory** | **Description** |
| ---------- | ------------ | -------- | -------- |
| handle     | Void*        | Yes       | ota instance  |

### 7.  Start download

`int iot_ota_fetch_yield(void *handle, char *buf, uint32_t buf_len, uint32_t timeout_s);`

API Description: Start download.

Return Value: Reading bytes will be returned if succeeded, download ended if the return value <0, and iot_ota_err_t if failed

Parameter Description:

| **Parameter Name** | **Parameter Type** | **Compulsory** | **Description**         |
| ---------- | ------------ | -------- | ---------------- |
| handle     | Void*        | Yes       | ota instance          |
| buf        | Char  *      | Yes       | Read buf          |
| buf_len    | Uint32_t     | Yes       | buf length        |
| Timeout_s  | Uint32_t     | Yes       | Time-out period in this read |

### 8. Obtain firmware information

`int iot_ota_get_firmware_info(void *handle, const char *product_key, const char *identifier, const char * version);`

API Description: Obtain firmware information of a designated version. You need to subscribe topic MQTT_SUB_TYPE_OTA_FIRMWARE_GET_INF_REPLY to return the request result.

Ø Return Value: packageid will be returned if succeeded and -1 will be returned if failed

Parameter Description:

| **Parameter Name**  | **Parameter Type** | **Compulsory** | **Description**          |
| ----------- | ------------ | -------- | ----------------- |
| handle      | Void*        | Yes       | ota instance           |
| product_key | Char  *      | Yes       | product key of device |
| identifier  | Char *       | Yes       | identifier of device  |
| version     | Char *       | Yes       | Version number to be searched  |

  Topic MQTT_SUB_TYPE_OTA_FIRMWARE_GET_INF_REPLY format:

`/sys/{productKey}/{identifier}/ota/firmware/get_reply`

Response data format:

If the firmware information is distributed, the response data format is as follows:

```
{
"msgId ":"123",//Information ID
"version":"1.0",//Protocol Version
"data ":{
	"firmwareVersion":"Firmware Version",
	"url":"Firmware Address",
	"sign":"Firmware Signature",
	"signMethod":"Md5"
	}
}
```

If no firmware information is distributed, the response data format is as follows:

```
{
"msgId ":"123",
"code":404,
"message":"FirmwareVersion {{firmwareVersion}} not existed"
}
```

